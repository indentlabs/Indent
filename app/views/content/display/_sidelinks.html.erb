<%
  creating = defined?(creating) && creating
  editing = defined?(editing) && editing
%>

<ul class="hoverable collection with-header content-tabs">
  <li class="collection-header center">
    <h4><%= @content.class.name %></h4>
  </li>

  <% if creating || editing %>
    <li class="collection-header center">
      <button class="btn waves-effect waves-<%= @content.class.color %> <%= @content.class.color %> mp-sidebar-save" type="submit" name="action" style="margin: 20px 0;">
        <%= @content.new_record? ? 'Create' : 'Save Changes' %>
      </button>
    </li>
  <% end %>

  <% @content.page_categories.each do |category| %>
    <% fields = category.page_fields %>
    <% field_ids_with_values = PageFieldValue.where.not(value: "").where(page_field_id: fields.pluck(:id)) %>
    <%
      #TODO: refactor ALL OF THIS

      # Don't show changelog tab on create/edit form
      next if (creating || editing) && category.name == 'changelog'

      if creating || editing
        # Show everything on create/edit forms
      elsif category.name == 'changelog'
        # Show changelog on show page
      elsif category.name == 'contributors'
        # Show contributors on show page if there are any to show
        next if @content.contributors.empty?
      elsif category.name == 'gallery'
        # Only show gallery tab if the content has any images
        next if @content.image_uploads.empty?
      else
        # Only show other tabs if it has at least one piece of data in it, or it's a custom tab
        next if field_ids_with_values.empty?
      end
    %>

    <li class="collection-item tab">
      <% #todo red-text if #tab is equal %>
      <a href="#<%= category.name %>_panel" class="<%= 'red-text' if category.label == 'Overview' %>">
        <i class="material-icons left"><%= category.icon %></i>
        <%= category.label.capitalize.presence || '(blank)' %>
      </a>
    </li>
  <% end %>

  <%# todo use universe permissions %>
  <% if user_signed_in? && current_user.id == @content.user_id %>
    <li class="collection-item">
      <a href="#" class="green-text new-attribute-field-link">
        <i class="material-icons left">add</i>
        Add custom category
      </a>
    </li>
  <% end %>
</ul>
